// ==UserScript==
// @name         Templerun Auto-Complete+
// @namespace    http://tampermonkey.net/
// @version      2025.12.02
// @description  ÏπòÏßÄÏßÅ, Ïà≤, Ïú†ÌäúÎ∏å ÎùºÏù¥Î∏åÏóêÏÑú Í∞ÄÏÇ¨Î•º ÏûêÎèôÏôÑÏÑ± Ìï¥Ï§çÎãàÎã§.  ÏùºÏπòÌïòÎäî Î∂ÄÎ∂ÑÏù¥ ÏûàÎäî Í∞ÄÏÇ¨ Ï∞æÍ∏∞(Ï¥àÏÑ±ÎèÑ Í∞ÄÎä•), ÏûÖÎ†•Ïù¥ Îπà Ïπ∏Ïùº Îïå Îã§Ïùå Í∞ÄÏÇ¨ ÎØ∏Î¶¨ ÎùÑÏö∞Í∏∞ Îì±Ïùò Í∏∞Îä•Ïù¥ ÏûàÏäµÎãàÎã§.
// @author       ÌÜµÎÇòÎ¨¥ÎåÄÎ¶¨ÏöîÏ°±
// @original     Nata
// @license      MIT
// @match        https://chzzk.naver.com/*
// @match        https://play.sooplive.co.kr/*
// @match        https://vod.sooplive.co.kr/*
// @match        https://www.youtube.com/*
// @match        *://www.youtube.com/live_chat*
// @run-at       document-idle
// @grant        unsafeWindow
// @grant        GM_addStyle
// ==/UserScript==

(function() {
  'use strict';
let isUpdating = false;
const isYoutubePopup = location.hostname.includes('youtube');

function getPopupIframe() {
  if (! isYoutubePopup) return null;

  const iframes = window.top.document.querySelectorAll('iframe');
  for (const iframe of iframes) {
    try {
      const popup = iframe.contentDocument.getElementById('autocomplete_popup');
      if (popup) return iframe;
    } catch(e) {}
  }
  return null;
}

function updatePopupVisibility() {
  if (isUpdating) return;
  isUpdating = true;

  const isEnabled = localStorage.getItem('ac. popup_enabled') !== 'false';

  let popups;
  if (isYoutubePopup) {
    const iframe = getPopupIframe();
    if (iframe) {
      popups = iframe.contentDocument.querySelectorAll('#autocomplete_popup');
    }
  } else {
    popups = document.querySelectorAll('#autocomplete_popup');
  }

  if (popups) {
    popups.forEach(popup => {
      const items = popup.querySelectorAll('.autocomplete_item');
      items.forEach(item => {
        if (item.textContent.trim() !== 'ÏÑ§Ï†ï') {
          item.style. setProperty('display', isEnabled ?  '' : 'none', 'important');
        }
      });
    });
  }

  isUpdating = false;
}

const popupObserver = new MutationObserver(() => {
  updatePopupVisibility();
});

const watchPopup = () => {
  if (isYoutubePopup) {
    const iframe = getPopupIframe();
    if (iframe) {
      popupObserver.observe(iframe.contentDocument.body, { childList: true, subtree:  true });
      return;
    }
  } else {
    const popup = document.getElementById('autocomplete_popup');
    if (popup) {
      popupObserver.observe(popup, { childList: true });
      return;
    }
  }
  setTimeout(watchPopup, 500);
};
watchPopup();
var isYoutubeForStyle = location.hostname.includes('youtube.com');

if(isYoutubeForStyle){
  var ytStyleObserver = new MutationObserver(function(){
    var doc = window.top.document;
    var settingsUI = doc. getElementById('autocomplete_settings');

    if(settingsUI && ! doc.getElementById('cac-yt-settings-style')){
      var styleEl = document.createElement('style');
      styleEl.id = 'cac-yt-settings-style';
      styleEl.textContent = '#autocomplete_settings, #autocomplete_settings * { font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", sans-serif ! important; font-size: 14px !important; color: rgb(255, 255, 255) !important; }';
      doc.head.appendChild(styleEl);
    }
  });
  ytStyleObserver.observe(window.top.document.body, { childList: true, subtree:  true });
}

    // ===== 1. Î∞±ÏóÖ/Î≥µÏõê Ïú†Ìã∏ =====
  function exportBackup() {
    const templates = JSON.parse(localStorage.getItem('ac.templates') || '[]');
    const settings = JSON.parse(localStorage.getItem('ac.settings') || '{}');

    const backup = {
      version: '2024.12.22',
      exportDate: new Date().toISOString(),
      templates: templates,
      settings: settings
    };

    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);

    const now = new Date();
    const filename = `cac-backup-${
      now.getFullYear()
    }${String(now.getMonth() + 1).padStart(2, '0')}${
      String(now.getDate()).padStart(2, '0')
    }-${
      String(now.getHours()).padStart(2, '0')
    }${String(now.getMinutes()).padStart(2, '0')}${
      String(now.getSeconds()).padStart(2, '0')
    }.json`;

    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    console.log(`[CAC] Backup exported: ${filename}`);
    alert(`‚úÖ Î∞±ÏóÖ ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§: ${filename}`);
  }

  function importBackup(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        try {
          const backup = JSON.parse(e.target.result);

          if (! backup.templates || !backup.settings) {
            throw new Error('Invalid backup file format');
          }

          // ÏÉà Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
          localStorage.setItem('ac.templates', JSON.stringify(backup.templates));
          localStorage. setItem('ac.settings', JSON.stringify(backup.settings));

          console.log('[CAC] Backup restored successfully');
          alert(`‚úÖ Î∞±ÏóÖÏù¥ Î≥µÏõêÎêòÏóàÏäµÎãàÎã§!\nÌÖúÌîåÎ¶ø: ${backup.templates. length}Í∞ú\nÏÑ§Ï†ïÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§. `);

          resolve({ success: true, backup });
        } catch (error) {
          console.error('[CAC] Import error:', error);
          alert(`‚ùå Î∞±ÏóÖ ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:\n${error.message}`);
          reject(error);
        }
      };

      reader.onerror = (e) => {
        console. error('[CAC] File read error:', e);
        reject(e);
      };

      reader. readAsText(file);
    });
  }

  // ===== 2. ÏÑ§Ï†ï ÌåùÏóÖÏóê Î∞±ÏóÖ/Î≥µÏõê Î≤ÑÌäº Ï∂îÍ∞Ä =====
  function addBackupButtonsToSettings() {
    const isYT = location.hostname.includes('youtube.com');
    const doc = isYT ? window.top.document : document;
    const checkAndAddButtons = setInterval(() => {
      const settingsModal = doc.getElementById('autocomplete_settings');
      if (!settingsModal) return;

      // Ïù¥ÎØ∏ Î∞±ÏóÖ Î≤ÑÌäºÏù¥ ÏûàÏúºÎ©¥ Ïä§ÌÇµ
      if (window.top.document.getElementById('backup-export-btn')) {
        clearInterval(checkAndAddButtons);
        return;
      }

      let leftPane = null;
if (location.hostname. includes('youtube.com')) {
  const allLeftPanes = window.top.document.querySelectorAll('.autocomplete_pane.left_pane');
  for (let i = 0; i < allLeftPanes.length; i++) {
    if (allLeftPanes[i].getBoundingClientRect().width > 0) {
      leftPane = allLeftPanes[i];
      break;
    }
  }
} else {
  leftPane = settingsModal.querySelector('.autocomplete_pane.left_pane');
}
if (! leftPane) return;

      // Î∞±ÏóÖ/Î≥µÏõê Î≤ÑÌäº Ïª®ÌÖåÏù¥ÎÑà
      const backupContainer = document.createElement('div');
      backupContainer.style.cssText = 'display:flex;gap:8px;margin-top:16px;border-top:1px solid rgba(115,119,127,0.3);padding-top:16px;';

      // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäº
      const exportBtn = document.createElement('button');
      exportBtn.id = 'backup-export-btn';
      exportBtn.className = 'autocomplete_button';
      exportBtn.textContent = 'üíæ Î∞±ÏóÖ ÎÇ¥Î≥¥ÎÇ¥Í∏∞';
      exportBtn.onclick = exportBackup;
      exportBtn.style.flex = '1';

      // Î∂àÎü¨Ïò§Í∏∞ Î≤ÑÌäº
      const importBtn = document.createElement('button');
      importBtn.id = 'backup-import-btn';
      importBtn.className = 'autocomplete_button';
      importBtn.textContent = 'üìÇ Î∞±ÏóÖ Î∂àÎü¨Ïò§Í∏∞';
      importBtn.style.flex = '1';

      // Ïà®Í≤®ÏßÑ ÌååÏùº ÏûÖÎ†•
      const fileInput = document.createElement('input');
      fileInput. type = 'file';
      fileInput.accept = '.json';
      fileInput.style.display = 'none';
      fileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if (file) {
    try {
      await importBackup(file);
      // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® (ÏÉà Îç∞Ïù¥ÌÑ∞ Î∞òÏòÅ)
      if (location.hostname.includes('youtube.com')) {
        setTimeout(() => window.top.location.reload(), 1000);
      } else {
        setTimeout(() => location.reload(), 1000);
      }
          } catch (err) {
            console.error('[CAC] Import failed:', err);
          }
        }
      };

      importBtn.onclick = () => fileInput.click();
const clearAllBtn = document.createElement('button');
clearAllBtn.id = 'backup-clear-btn';
clearAllBtn.className = 'autocomplete_button';
clearAllBtn.textContent = 'üóëÔ∏è Ï†ÑÏ≤¥ ÏÇ≠Ï†ú';
clearAllBtn.style.flex = '1';
clearAllBtn.style.background = '#dc3545';
clearAllBtn.onclick = () => {
  if (confirm('Ï†ïÎßê Î™®Îì† ÌÖúÌîåÎ¶øÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?')) {
    localStorage.removeItem('ac.templates');
    localStorage.removeItem('ac.  templates');
    if (location.hostname.includes('youtube.com')) {
      window.top.location.reload();
    } else {
      location. reload();
    }
  }
};
      backupContainer.append(exportBtn, importBtn, clearAllBtn, fileInput);
        // ÌÜ†Í∏Ä Ïª®ÌÖåÏù¥ÎÑà
const toggleContainer = document.createElement('div');
toggleContainer.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(115,119,127,0.3);';

// ÎùºÎ≤®
const toggleLabel = document.createElement('span');
toggleLabel.textContent = 'ÏûêÎèô ÏôÑÏÑ± Í∏∞Îä•';
toggleLabel.style.cssText = 'color:#fff;font-size:14px;';

// ÌÜ†Í∏Ä Ïä§ÏúÑÏπò
const toggleSwitch = document.createElement('div');
const isEnabled = localStorage.getItem('ac. popup_enabled') !== 'false';
toggleSwitch.style.cssText = `width:50px;height:26px;border-radius:13px;cursor:pointer;position:relative;transition:background 0.3s;background: ${isEnabled ? '#5c6bc0' : '#555'};`;

const toggleKnob = document.createElement('div');
toggleKnob.style.cssText = `width:22px;height:22px;border-radius:50%;background:#fff;position:absolute;top:2px;transition:left 0.3s;left:${isEnabled ? '26px' : '2px'};`;
toggleSwitch.appendChild(toggleKnob);

toggleSwitch.onclick = () => {
  const newState = localStorage.getItem('ac. popup_enabled') === 'false';
  localStorage.setItem('ac. popup_enabled', newState);
  toggleKnob.style.left = newState ? '26px' : '2px';
  toggleSwitch.style.background = newState ? '#5c6bc0' : '#555';
  updatePopupVisibility();

};
toggleContainer.append(toggleLabel, toggleSwitch);
      leftPane.insertBefore(backupContainer,leftPane.children[2]);
      leftPane.insertBefore(toggleContainer, backupContainer);

      clearInterval(checkAndAddButtons);
    }, 500);

    // 20Ï¥à ÌõÑ Ìè¨Í∏∞
    setTimeout(() => clearInterval(checkAndAddButtons), 20000);
  }
if (location.hostname.includes('youtube.com')) {
  // 5Ï¥à ÌõÑÏóê Ïã§Ìñâ (CAC ÏõêÎ≥∏ ÏΩîÎìúÍ∞Ä Îã§ Ïã§ÌñâÎêú ÌõÑ)
  setTimeout(() => {
    const iframe = document.querySelector('iframe#chatframe');
    if (iframe && iframe.contentDocument) {
      iframe.contentDocument.addEventListener('click', (e) => {
        const target = e.target.closest('.autocomplete_item');
        if (target && target.textContent.trim() === 'ÏÑ§Ï†ï') {
          const allSettings = window.top.document.querySelectorAll('#autocomplete_settings');
          const ourSettings = allSettings[allSettings. length - 1];
          if (ourSettings) ourSettings.classList.add('opened');
        }
      }, true);
    }

    window.top.document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const allSettings = window.top. document.querySelectorAll('#autocomplete_settings');
        const ourSettings = allSettings[allSettings.length - 1];
        if (ourSettings) ourSettings.classList.remove('opened');
      }
    }, true);
  }, 5000);
}
  // ===== 2. CSS Ïä§ÌÉÄÏùº =====
  GM_addStyle(`
/* ÌåùÏóÖ Ïä§ÌÉÄÏùº */
#autocomplete_popup {
  display: flex;
  position: absolute;
  bottom: 48px;
  width: calc(100% - 10px);
  flex-direction: column;
  height: max-content;
  max-height: 150px;
 overflow-y: scroll !important;
  z-index: 9;
  background: rgb(56, 58, 62) !important;
  border: 0px none !important;
  border-radius: 12px 0 0 12px !important;
}

html #autocomplete_popup .autocomplete_item {
  padding: 8px 28px;
  line-height: normal;
  word-break: keep-all;
  white-space: pre-wrap;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  font-size: 14px !important;
  color: rgba(255, 255, 255, 0.8) !important;
  font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif !important;
}

#autocomplete_popup .autocomplete_item:hover,
#autocomplete_popup .autocomplete_item.selected {
  background: rgb(79, 82, 88) !important;
}

#autocomplete_popup .autocomplete_item:active {
  background: rgb(91, 94, 101) !important;
}

.autocomplete_subtext {
  color: rgba(255, 255, 255, 0.5) !important;
  font-size: 12px !important;
  font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif !important;
}

/* ÏÑ§Ï†ï UI Ïä§ÌÉÄÏùº */
#autocomplete_settings {
  display: none;
  position: fixed;
  top: 32px;
  bottom: 32px;
  left: 32px;
  right: 32px;
  overflow-y: scroll;
  padding: 24px;
  gap: 24px;
  background: rgba(56, 58, 62, 0.875);
  border: 1px solid rgba(115, 119, 127, 0.75);
  border-radius: 12px 0 0 12px !important;
  backdrop-filter: blur(4px);
  z-index: 99999;
}

#autocomplete_settings.opened {
  display: flex;
}

.autocomplete_button {
  display: flex;
  flex-shrink: 0;
  padding: 12px 24px;
  border: 0.8px solid rgba(115, 119, 127, 0.5) !important;
  border-radius: 6px;
  line-height: normal;
  align-items: center;
  justify-content: center;
  word-break: keep-all;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  background: rgba(0, 0, 0, 0) !important;
  color: rgb(255, 255, 255) !important;
  font-size: 14px !important;
  font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif !important;
  transition: background 0.2s cubic-bezier(0.2, 1, 0.5, 0.95);
}

.autocomplete_button:hover,
.autocomplete_button.selected {
  background: rgb(79, 82, 88) !important;
}

.autocomplete_button:active {
  background: rgb(91, 94, 101) !important;
}

.autocomplete_button.left {
  justify-content: flex-start;
}

#backup-export-btn,
#backup-import-btn {
  padding: 12px 24px;
  border: 0.8px solid rgba(115, 119, 127, 0.5) !important;
  border-radius: 6px;
  background: rgba(0, 0, 0, 0) !important;
  color: rgb(255, 255, 255) !important;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s cubic-bezier(0.2, 1, 0.5, 0.95);
  font-weight: bold;
}

#backup-export-btn:hover,
#backup-import-btn:hover {
  background: rgb(79, 82, 88) !important;
}

#backup-export-btn:active,
#backup-import-btn:active {
  background: rgb(91, 94, 101) !important;
}

.autocomplete_pane {
  display: flex;
  width: 100%;
  height: 100%;
  gap: 8px;
  flex-direction: column;
  overflow-y: scroll;
}

.autocomplete_pane.right_pane {
  display: flex;
  width: 100%;
  height: 100%;
  flex-direction: column;
}

/* Ïò§Î•∏Ï™Ω Î∂ÄÎ∂Ñ(right_pane) INPUT Ïä§ÌÉÄÏùº */
.autocomplete_pane.right_pane input {
  background-color: rgb(21, 22, 25) !important;
  color: rgb(255, 255, 255) !important;
  border: 1.6px solid rgb(115, 119, 127) !important;
  border-radius: 8px !important;
  padding: 12px 16px !important;
  font-size: 14px !important;
  font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.autocomplete_pane.right_pane input:hover {
  background-color: rgb(33, 34, 37) !important;
  border-color: rgb(140, 145, 155) !important;
}

.autocomplete_pane.right_pane input:focus {
  background-color: rgb(33, 34, 37) !important;
  border-color: rgb(167, 171, 180) !important;
}

/* Ïò§Î•∏Ï™Ω Î∂ÄÎ∂Ñ(right_pane) DIV ÎùºÎ≤® Ïä§ÌÉÄÏùº */
.autocomplete_pane.right_pane > div:not(input):not(button) {
  color: rgb(255, 255, 255) !important;
  font-size: 14px !important;
  font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif !important;
  font-weight: 400 !important;
  padding: 0px !important;
  margin: 0px !important;
  line-height: 16.8px !important;
}

/* Ïò§Î•∏Ï™Ω Î∂ÄÎ∂Ñ(right_pane) BUTTON Ïä§ÌÉÄÏùº */
.autocomplete_pane.right_pane button {
  background-color: rgba(0, 0, 0, 0) !important;
  color: rgb(255, 255, 255) !important;
  border: 0.8px solid rgba(115, 119, 127, 0.5) !important;
  border-radius: 6px !important;
  padding: 12px 24px !important;
  font-size: 14px !important;
  font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif !important;
  cursor: pointer !important;
  transition: color 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), background-color 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), border-color 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), text-decoration-color 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), fill 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), stroke 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), opacity 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), box-shadow 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), transform 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), filter 0.2s cubic-bezier(0.2, 1, 0.5, 0.95), backdrop-filter 0.2s cubic-bezier(0.2, 1, 0.5, 0.95) !important;
}

.autocomplete_pane.right_pane button:hover {
  background-color: rgb(79, 82, 88) !important;
}

.autocomplete_pane.right_pane button:active {
  background-color: rgb(91, 94, 101) !important;
}

.autocomplete_input {
  display: flex;
  position: relative;
  width: 100%;
  margin: 0;
  outline: none;
  border: 2px solid rgb(115, 119, 127);
  border-radius: 8px;
  padding: 12px 16px;
  line-height: normal;
  align-items: center;
  background: rgb(21, 22, 25);
  color: white;
  cursor: text;
}

.autocomplete_input:hover,
.autocomplete_input:focus {
  background: rgb(33, 34, 37);
}

.autocomplete_input:hover {
  border-color: rgb(140, 145, 155);
}

.autocomplete_input:focus {
  border-color: rgb(167, 171, 180);
}

.autocomplete_textarea {
  display: flex;
  position: relative;
  width: 100%;
  height: 100%;
  margin: 0;
  outline: none;
  border: 2px solid rgb(115, 119, 127);
  border-radius: 8px;
  padding: 12px 16px;
  line-height: normal;
  align-items: center;
  background: rgb(21, 22, 25);
  color: white;
  cursor: text;
}

.autocomplete_textarea:hover,
.autocomplete_textarea:focus {
  background: rgb(33, 34, 37);
}

.autocomplete_textarea:hover {
  border-color: rgb(140, 145, 155);
}

.autocomplete_textarea:focus {
  border-color: rgb(167, 171, 180);
}

.transition {
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
  transition-timing-function: cubic-bezier(0.2, 1, 0.5, 0.95);
  transition-duration: 0.2s;
}
  `);

  // ===== 3. MutationObserverÎ°ú right_pane Ïä§ÌÉÄÏùº Í∞ïÏ†ú Ï†ÅÏö© =====
  let styleObserverInitialized = false;

  const applyRightPaneStyles = () => {
  const rightPane = document.querySelector('.autocomplete_pane.right_pane');
  if (! rightPane) return;

  // INPUT ÏöîÏÜåÎì§
  rightPane.querySelectorAll('input'). forEach(input => {
    input.style.backgroundColor = 'rgb(21, 22, 25)';
    input.style. color = 'rgb(255, 255, 255)';
    input.style.border = '1. 6px solid rgb(115, 119, 127)';
    input.style.borderRadius = '8px';
    input.style. padding = '12px 16px';
    input.style. fontSize = '14px';
    input.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif';
    input.style.width = '100%';
    input.style.boxSizing = 'border-box';
  });

  // DIV ÎùºÎ≤® ÏöîÏÜåÎì§ (Î™®Îì† DIVÏóê Ïä§ÌÉÄÏùº Ï†ÅÏö© - TEXT ÎÖ∏ÎìúÏùò Î∂ÄÎ™®)
    // DIV/LABEL/SPAN Îì± Îã§Î•∏ ÏöîÏÜåÎì§
  rightPane.querySelectorAll('div'). forEach(div => {
    if (div.tagName !== 'INPUT' && div.tagName !== 'BUTTON') {
      div.style.color = 'rgb(255, 255, 255)';
      div.style.fontSize = '14px';
      div.style. fontFamily = '-apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif';
      div.style.fontWeight = '400';
      div. style.lineHeight = '16. 8px';
    }
  });

  // TEXT ÎÖ∏ÎìúÎ•º SPANÏúºÎ°ú Í∞êÏã∏ÏÑú Ïä§ÌÉÄÏùº Ï†ÅÏö©
  rightPane.childNodes.forEach(node => {
    if (node.nodeType === Node.TEXT_NODE && node. textContent.trim().length > 0) {
      const span = document.createElement('span');
      span.style.color = 'rgb(255, 255, 255)';
      span.style.fontSize = '14px';
      span.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif';
      span.style.fontWeight = '400';
      span.style.lineHeight = '16.8px';
      span.style.display = 'block';
      span.appendChild(node.cloneNode(true));
      node. parentNode.insertBefore(span, node);
      node.parentNode.removeChild(node);
    }
  });

  // BUTTON ÏöîÏÜåÎì§
  rightPane.querySelectorAll('button').forEach(button => {
    button.style.backgroundColor = 'rgba(0, 0, 0, 0)';
    button.style.color = 'rgb(255, 255, 255)';
    button.style. border = '0.8px solid rgba(115, 119, 127, 0.5)';
    button.style.borderRadius = '6px';
    button.style.padding = '12px 24px';
    button.style.fontSize = '14px';
    button.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif';
    button.style. cursor = 'pointer';
  });
};
  // DOM Î≥ÄÍ≤Ω Í∞êÏãú
  const styleObserver = new MutationObserver(() => {
    applyRightPaneStyles();
  });

  // ÏòµÏ†ÄÎ≤Ñ ÏãúÏûë
  const startStyleObserver = () => {
    if (!styleObserverInitialized) {
      styleObserver.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
      });
      styleObserverInitialized = true;
      console.log('[CAC] Style observer started');
    }
    applyRightPaneStyles();
  };

  // Ï¥àÍ∏∞ Ï†ÅÏö© Î∞è Í∞êÏãú
  startStyleObserver();

  // ===== 4. SOOP font-family Í∞ïÏ†ú Ï†ÅÏö© =====
  const applyFontFix = () => {
    const items = document.querySelectorAll('#autocomplete_popup .autocomplete_item');
    items.forEach(item => {
      item.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Malgun Gothic", "ÎßëÏùÄ Í≥†Îîï", Helvetica, Arial, sans-serif';
      item.style.fontSize = '14px';
      item.style.color = 'rgba(255, 255, 255, 0.8)';
    });
  };

  // ÏöîÏÜåÍ∞Ä ÏÉùÏÑ±/Î≥ÄÍ≤ΩÎê† ÎïåÎßàÎã§ Ï†ÅÏö©
  const observer = new MutationObserver(() => {
    applyFontFix();
  });

  observer.observe(document.body, { childList: true, subtree: true });

  // Ï¥àÍ∏∞ Ï†ÅÏö©
  applyFontFix();
  addBackupButtonsToSettings();

function updateLeftPaneScrollbar(){
  var target=document.querySelector('.autocomplete_pane.left_pane');
  if(!target)return;
  var rect=target. getBoundingClientRect();
  var track=document.querySelector('.cac-scrollbar-track[data-target-id="leftpane"]');
  if(rect.width===0||rect.height===0){
    if(track)track.style.display='none';
    return;
  }
  if(! track){track=createTrack('leftpane',null);}
  track.style.display='flex';
  track.style.top=rect.top+'px';
  track.style.left=(rect.right-14)+'px';
  track.style.height=rect.height+'px';
  updateThumb(target,track);
}

function updateRightPaneScrollbar(){
  var target=document.querySelector('.autocomplete_pane.right_pane');
  if(!target)return;
  var rect=target.getBoundingClientRect();
  var track=document.querySelector('.cac-scrollbar-track[data-target-id="rightpane"]');
  if(rect.width===0||rect.height===0){
    if(track)track.style.display='none';
    return;
  }
  if(!track){track=createTrack('rightpane',null);}
  track.style.display='flex';
  track.style.top=rect.top+'px';
  track.style.left=(rect. right-14)+'px';
  track.style.height=rect.height+'px';
  updateThumb(target,track);
}

function updateSettingsScrollbar(){
  var target=document. getElementById('autocomplete_settings');
  if(!target)return;
  var rect=target.getBoundingClientRect();
  var track=document.querySelector('.cac-scrollbar-track[data-target-id="settings"]');
  if(rect.width===0||rect.height===0){
    if(track)track.style.display='none';
    return;
  }
  if(! track){track=createTrack('settings',null);}
  track.style.display='flex';
  track.style.top=(rect.top+1)+'px';
  track.style.left=(rect.right-14-1)+'px';
  track.style.height=(rect.height-2)+'px';
  updateThumb(target,track);
}

function updatePopupScrollbar(){
  var popup=document.getElementById('autocomplete_popup');
  if(!popup)return;
  var rect=popup.getBoundingClientRect();
  var track=popup.querySelector('.cac-scrollbar-track[data-target-id="popup"]');
  if(rect.width===0||rect.height===0){
    if(track)track.style.display='none';
    return;
  }
  var wrapper=createPopupWrapper();
  if(!wrapper)return;
  if(!track){track=createTrack('popup',popup);}
  track.style.display='flex';
  updateThumb(wrapper,track);
}

var dragInfo=null;
document.addEventListener('mousedown',function(e){
if(e.target.classList.contains('cac-scrollbar-thumb')){
var track=e.target.closest('.cac-scrollbar-track');
var targetId=track.dataset.targetId;
var target;
if(targetId==='leftpane')target=document.querySelector('.autocomplete_pane.left_pane');
else if(targetId==='rightpane')target=document.querySelector('.autocomplete_pane.right_pane');
else if(targetId==='settings')target=document.getElementById('autocomplete_settings');
else if(targetId==='popup')target=document.getElementById('autocomplete_popup');
if(target){
dragInfo={target:target,startY:e.clientY,startScrollTop:target.scrollTop};
e.preventDefault();
}
}
});
document.addEventListener('mousemove',function(e){
if(!dragInfo)return;
var target=dragInfo.target;
var deltaY=e.clientY-dragInfo.startY;
var scrollHeight=target.scrollHeight;
var clientHeight=target.clientHeight;
var thumbHeight=Math.max((clientHeight/scrollHeight)*clientHeight,30);
var scrollDelta=(deltaY/(clientHeight-thumbHeight))*(scrollHeight-clientHeight);
target.scrollTop=dragInfo.startScrollTop+scrollDelta;
});
document.addEventListener('mouseup',function(){dragInfo=null;});

function hideNativeScrollbar(){
var settings=document.getElementById('autocomplete_settings');
if(settings){settings.style.setProperty('scrollbar-width','none','important');}
var panes=document.getElementsByClassName('autocomplete_pane');
for(var i=0;i<panes.length;i++){
panes[i].style.setProperty('scrollbar-width','none','important');
panes[i].style.setProperty('padding-right','14px','important');
}
var popup=document.getElementById('autocomplete_popup');
if(popup){
popup.style.setProperty('scrollbar-width','none','important');
popup.style.setProperty('overflow','hidden','important');
}
}

var style=document.createElement('style');
style.textContent='#autocomplete_settings: :-webkit-scrollbar,. autocomplete_pane::-webkit-scrollbar,#autocomplete_popup::-webkit-scrollbar{display:none! important;}';
document.head.appendChild(style);

function createTrack(targetId,parent){
var track=document.createElement('div');
track.className='cac-scrollbar-track';
track.dataset.targetId=targetId;
var isInside=(targetId==='popup');
if(isInside){
track.style.cssText='position:absolute;right:0;top:0;width:14px;height:100%;background:#2c2c2c;z-index:10;display:flex;flex-direction:column;pointer-events:none;';
}else{
track.style.cssText='position:fixed;width:14px;background:#2c2c2c;z-index:9999999;display:flex;flex-direction: column;pointer-events:none;';
}
var upBtn=document.createElement('div');
upBtn.className='cac-scrollbar-up';
upBtn. textContent='‚ñ≤';
upBtn.style.cssText='width:14px;height:14px;background:#2c2c2c;color:#9f9f9f;font-size:10px;display:flex;align-items:center;justify-content: center;cursor:pointer;user-select:none;pointer-events: auto;';
upBtn.addEventListener('mouseenter',function(){this.style.color='#d1d1d1';});
upBtn.addEventListener('mouseleave',function(){this.style.color='#9f9f9f';});
upBtn.addEventListener('mousedown',function(){this.style.color='#d1d1d1';});
upBtn.addEventListener('mouseup',function(){this.style.color='#9f9f9f';});
upBtn.addEventListener('click',function(){var t;if(targetId==='leftpane')t=document.querySelector('.autocomplete_pane.left_pane');else if(targetId==='rightpane')t=document.querySelector('.autocomplete_pane.right_pane');else if(targetId==='settings')t=document.getElementById('autocomplete_settings');else if(targetId==='popup')t=document.getElementById('autocomplete_popup');if(t)t.scrollTop-=50;});
var middle=document. createElement('div');
middle.className='cac-scrollbar-middle';
middle.style.cssText='flex: 1;position:relative;background:#2c2c2c;';
var thumb=document.createElement('div');
thumb.className='cac-scrollbar-thumb';
thumb.style.cssText='position:absolute;left:50%;transform:translateX(-50%);width:9px;background:#9f9f9f;border-radius:4px;pointer-events:auto;cursor:pointer;';
thumb.addEventListener('mouseenter',function(){this.style.background='#d1d1d1';});
thumb.addEventListener('mouseleave',function(){if(! dragInfo)this.style.background='#9f9f9f';});
middle.appendChild(thumb);
var downBtn=document.createElement('div');
downBtn.className='cac-scrollbar-down';
downBtn.textContent='‚ñº';
downBtn.style.cssText='width:14px;height: 14px;background:#2c2c2c;color:#9f9f9f;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;pointer-events:auto;';
downBtn.addEventListener('mouseenter',function(){this.style.color='#d1d1d1';});
downBtn.addEventListener('mouseleave',function(){this.style.color='#9f9f9f';});
downBtn.addEventListener('mousedown',function(){this.style.color='#d1d1d1';});
downBtn.addEventListener('mouseup',function(){this.style.color='#9f9f9f';});
downBtn.addEventListener('click',function(){var t;if(targetId==='leftpane')t=document.querySelector('.autocomplete_pane.left_pane');else if(targetId==='rightpane')t=document.querySelector('.autocomplete_pane.right_pane');else if(targetId==='settings')t=document.getElementById('autocomplete_settings');else if(targetId==='popup')t=document.getElementById('autocomplete_popup');if(t)t.scrollTop+=50;});
track.appendChild(upBtn);
track.appendChild(middle);
track.appendChild(downBtn);
if(parent){
parent.appendChild(track);
}else{
document.body.appendChild(track);
}
return track;
}

function updateThumb(target,track){
var thumb=track.querySelector('.cac-scrollbar-thumb');
var scrollHeight=target.scrollHeight;
var clientHeight=target.clientHeight;
var scrollTop=target.scrollTop;
var trackHeight=track.offsetHeight-28;
if(scrollHeight<=clientHeight){
thumb.style.display='none';
}else{
thumb.style.display='block';
var thumbHeight=Math.max((clientHeight/scrollHeight)*trackHeight,30);
var thumbTop=(scrollTop/(scrollHeight-clientHeight))*(trackHeight-thumbHeight);
thumb.style.height=thumbHeight+'px';
thumb.style.top=thumbTop+'px';
}
}

function updateLeftPaneScrollbar(){
var doc=(isYoutubePopup&&window. top)?window.top.document:document;
var target=doc. querySelector('.autocomplete_pane.left_pane');
if(!target)return;
var rect=target.getBoundingClientRect();
var track=document.querySelector('.cac-scrollbar-track[data-target-id="leftpane"]');
if(rect.width===0||rect.height===0){
if(track)track.style.display='none';
return;
}
if(! track){track=createTrack('leftpane',null);}
track.style.display='flex';
track.style.top=rect.top+'px';
track. style.left=(rect.right-14)+'px';
track.style.height=rect.height+'px';
updateThumb(target,track);
}

function updateRightPaneScrollbar(){
var doc=(isYoutubePopup&&window.top)?window.top.document:document;
var target=doc.querySelector('.autocomplete_pane.right_pane');
if(!target)return;
var rect=target.getBoundingClientRect();
var track=document.querySelector('.cac-scrollbar-track[data-target-id="rightpane"]');
if(rect.width===0||rect.height===0){
if(track)track.style.display='none';
return;
}
if(!track){track=createTrack('rightpane',null);}
track.style.display='flex';
track.style.top=rect.top+'px';
track.style.left=(rect. right-14)+'px';
track.style.height=rect. height+'px';
updateThumb(target,track);
}

function updateSettingsScrollbar(){
var target=document.getElementById('autocomplete_settings');
if(!target)return;
var rect=target.getBoundingClientRect();
var track=document.querySelector('.cac-scrollbar-track[data-target-id="settings"]');
if(rect.width===0||rect.height===0){
if(track)track.style.display='none';
return;
}
if(! track){track=createTrack('settings',null);}
track.style.display='flex';
track.style.top=(rect.top+1)+'px';
track.style.left=(rect.right-14-1)+'px';
track.style.height=(rect.height-2)+'px';
updateThumb(target,track);
}

function createPopupWrapper(){
var popup=document.getElementById('autocomplete_popup');
if(!popup)return null;
var wrapper=popup.querySelector('.cac-popup-wrapper');
if(!wrapper){
wrapper=document.createElement('div');
wrapper.className='cac-popup-wrapper';
wrapper.style.cssText='position:relative;width:100%;height:100%;overflow-y:auto;scrollbar-width:none;';
while(popup.firstChild){
wrapper.appendChild(popup.firstChild);
}
popup.appendChild(wrapper);
}
return wrapper;
}
  // ===== 4-1. Ïª§Ïä§ÌÖÄ Ïä§ÌÅ¨Î°§Î∞î =====
function updatePopupScrollbar(){
var popup=document.getElementById('autocomplete_popup');
if(!popup)return;
var rect=popup.getBoundingClientRect();
var track=popup.querySelector('.cac-scrollbar-track[data-target-id="popup"]');
if(rect.width===0||rect.height===0){
if(track)track.style.display='none';
return;
}
var wrapper=createPopupWrapper();
if(!wrapper)return;
if(!track){track=createTrack('popup',popup);}
track.style.display='flex';
updateThumb(wrapper,track);
}

setInterval(function(){
hideNativeScrollbar();
updateLeftPaneScrollbar();
updateRightPaneScrollbar();
updateSettingsScrollbar();
updatePopupScrollbar();
},50);

console.log('[CAC] Ïª§Ïä§ÌÖÄ Ïä§ÌÅ¨Î°§Î∞î Ï†ÅÏö© ÏôÑÎ£å');

// ===== SOOP Î≥µÏÇ¨/Î∂ôÏó¨ÎÑ£Í∏∞ ÌôúÏÑ±Ìôî =====
function enableCopyPaste(){
  var targets = [
    '#write_area',
    '#auqa_voice_textarea',
    '#adb_auqa_voice_textarea'
  ];

  targets.forEach(function(selector){
    var el = document.querySelector(selector);
    if(!el) return;
    if(el.dataset.copyPasteEnabled) return; // Ï§ëÎ≥µ Î∞©ÏßÄ

    // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Ï†úÍ±∞
    el.removeAttribute('onpaste');
    el.removeAttribute('oncopy');
    el.removeAttribute('ondragenter');
    el.removeAttribute('ondrop');
    el.removeAttribute('ondragover');

    // Î∂ôÏó¨ÎÑ£Í∏∞ ÏßÅÏ†ë Ï≤òÎ¶¨
    el.addEventListener('paste', function(e){
      e.preventDefault();
      e.stopPropagation();

      var text = (e.clipboardData || window. clipboardData).getData('text');
      if(!text) return;

      var sel = window.getSelection();
      if(! sel. rangeCount) return;

      // ÌòÑÏû¨ ÏÑ†ÌÉù ÏòÅÏó≠ ÏÇ≠Ï†ú ÌõÑ ÌÖçÏä§Ìä∏ ÏÇΩÏûÖ
      var range = sel.getRangeAt(0);
      range.deleteContents();
      var textNode = document.createTextNode(text);
      range.insertNode(textNode);

      // Ïª§ÏÑúÎ•º ÌÖçÏä§Ìä∏ ÎÅùÏúºÎ°ú Ïù¥Îèô
      range.setStartAfter(textNode);
      range.setEndAfter(textNode);
      sel.removeAllRanges();
      sel.addRange(range);
    }, true);

    el.addEventListener('copy', function(e){ e.stopPropagation(); }, true);

    el.dataset.copyPasteEnabled = 'true';
  });
}

setInterval(enableCopyPaste, 500);
// Ïù¥ ÏïÑÎûòÎ∂ÄÌÑ∞Îäî CAC ÏõêÎ≥∏ ÏΩîÎìú (https://github.com/GOWESTBPA/-/blob/main/5.%20%EA%B8%B0%EC%A1%B4%20CAC%20%EC%BD%94%EB%93%9C) //
